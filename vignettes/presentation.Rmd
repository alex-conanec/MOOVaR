---
title: "Vignette Title"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: 
    html_document:
    toc: true
    number_sections: true
    toc_depth: 2
    theme: united
    highlight: tango
    toc_float:
      collapsed: false
      smooth_scroll: false
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    fig.width = 7,
    fig.height = 6,
  collapse = TRUE,
  comment = "#>"
)
```


```{r include=FALSE}
library(dplyr)
library(tidyr)
library(NSGA2)
library(randomForest)
library(parallel)
library(ggpubr)

numCores <- detectCores()
```

# Couple de fonctions à optimiser

```{r}
#generate data
set.seed(125)
F1 <- function(X) 2*X[,1] + X[,2]^2 + X[,1]*X[,4]
F2 <- function(X) 1.25*X[,2] + X[,4]^2 + X[,1]*X[,2]

X <- matrix(runif(200, min = 0, max = 10), ncol = 4) %>% as.data.frame()

sd_tests <- list(sd_1_1 = c(1, 1), sd_15_15 = c(15, 15), sd_30_30 = c(30, 30),
                 sd_1_15 = c(1, 15), sd_15_1 = c(15, 1))
list_Y <- lapply(sd_tests, function(couple_sd){
    set.seed(125)
    tmp=runif(200, min = 0, max = 10)
    data.frame(Y1 = F1(X) + rnorm(NROW(X), sd=couple_sd[1]),
               Y2 = F2(X) + rnorm(NROW(X), sd=couple_sd[2]))
})

# modelisation following two algorithm: rf and lm
formule1 <- as.formula("Y~V1 + V2 + V1:V4")
formule2 <- as.formula("Y~V2 + V4 + V1:V2")

model_lm <- lapply(seq_len(length(sd_tests)), function(i){
    list(f1 = lm(formule1, data = cbind(Y=list_Y[[i]][,1], X)),
         f2 = lm(formule2, data = cbind(Y=list_Y[[i]][,2], X))
         )
})

model_rf <- lapply(seq_len(length(sd_tests)), function(i){
    list(f1 = randomForest(x=X, y=list_Y[[i]][,1]),
         f2 = randomForest(x=X, y=list_Y[[i]][,2])
    )
})

#big X space to visualize the objective space 
X_big <- matrix(runif(160000, min = 0, max = 10), ncol = 4) %>% as.data.frame()

```

# Stabilité de la convergence de NSGA

```{r warning=FALSE}
#check stability of NSGA
files_stabi <- list.files("../simu_server/stabi_NSGA/output/")
names(files_stabi) <- files_stabi
list_simu_stabi <- lapply(files_stabi, function(file_name){
    readRDS(paste0("../simu_server/stabi_NSGA/output/", file_name))
})
list_simu_stabi <- list_simu_stabi[list_simu_stabi %>% sapply(function(res){
    res$config$B
}) %>% order]

solution_space <- data.frame(f1=F1(X_big),
                             f2=F2(X_big))
# view_f1 <- list_simu_stabi %>% mclapply(plot, f_studied=2, f_view=1,
#                                         solution_space = solution_space,
#                                         mc.cores = numCores, breaks = 500)
# view_f2 <- list_simu_stabi %>% mclapply(plot, f_studied=1, f_view=2,
#                                         solution_space = solution_space, 
#                                         mc.cores = numCores, breaks = 500)
view_f1 <- list_simu_stabi %>% lapply(plot, f_studied=2, f_view=1,
                                      solution_space = solution_space, 
                                      breaks = 500)
view_f2 <- list_simu_stabi %>% lapply(plot, f_studied=1, f_view=2,
                                      solution_space = solution_space, 
                                      breaks = 500)
view_front <- list_simu_stabi %>% lapply(plot, f_studied = 2, f_view = 1,
                                      solution_space = solution_space, 
                                      breaks = 500, choice = "sol_space")
```


## Zoom sur le front {.tabset .tabset-fade .tabset-pills}
```{r include=FALSE}
title <- c(10, 25, 50, 100, 200, 500, 1000)
out <- lapply(seq_along(title), function(i) {
    paste(knitr::knit_expand(text = paste0("###", title[i], "\n")),
          knitr::knit_expand(text = paste0("\n```{r ", "B", i, ", echo = FALSE}")),
          knitr::knit_expand(text = paste0("\n view_front", "[[", i, "]]")),
          knitr::knit_expand(text = "\n```\n"),
          collapse = '\n')
})

```

`r paste(knitr::knit(text = paste(out, collapse = '\n')))`

## Variation de B analyse en fonction de f1 {.tabset .tabset-fade .tabset-pills}

```{r include=FALSE}
front_traits <- tibble(
    id = "f1",
    B = title,
    var_mean = sapply(view_f1, function(v){
        v$var_mean
        }),
    var_sd = sapply(view_f1, function(v){
        v$var_sd
        })
    ) %>% bind_rows(
        tibble(
            id = "f2",
            B = title,
            var_mean = sapply(view_f2, function(v){
                v$var_mean
                }),
            var_sd = sapply(view_f2, function(v){
                v$var_sd
                })
            )
        ) %>% mutate(id = as.factor(id))

out <- lapply(c(f1=1, f2=2), function(k){
        lapply(seq_along(title), function(i) {
            paste(knitr::knit_expand(text = paste0("###", title[i], "\n")),
              knitr::knit_expand(text = paste0("\n```{r f", k, "B", i, ", echo = FALSE}")),
              knitr::knit_expand(text = paste0("\n view_f", k, "[[", i, "]]$plot")),
              knitr::knit_expand(text = "\n```\n"),
              collapse = '\n')
    })
})

```

`r paste(knitr::knit(text = paste(out[["f1"]], collapse = '\n')))`

## Variation de B analyse en fonction de f2 {.tabset .tabset-fade .tabset-pills}

`r paste(knitr::knit(text = paste(out[["f2"]], collapse = '\n')))`

## Evolution de la variabilité moyenne

```{r}
var_mean_plot <- ggplot(front_traits) +
    geom_line(aes(x = B, y = var_mean, colour = id))
var_mean_plot
```

## Evolution de l'ecart-type de la variabilité 

```{r}
var_sd_plot <- ggplot(front_traits) +
    geom_line(aes(x = B, y = var_sd, colour = id))
var_sd_plot
``` 

# Approach bootstrap

## Description de la qualité des modeles

```{r}
# biais de modelisation
#with simulated data
X_plot <- as.data.frame(matrix(5, ncol = 4, nrow = 100))
x <- seq(0, 10, length.out = 100)
colnames(X_plot) <- colnames(X)

lapply(list(model_lm, model_rf), function(model){
    lapply(c(1,3), function(k){
        lapply(1:2, function (j){
            lapply(1:4, function(i){
                X_plot[,i] <- x
                data <- data.frame(x=x,
                                   y_true=list(F1, F2)[[j]](X_plot),
                                   y_pred = predict(list(model[[k]]$f1,
                                                         model[[k]]$f2)
                                                    [[j]], X_plot)) %>%
                    gather(key = y_form, value=y, -x) %>%
                    ggplot() +
                    geom_line(aes(x = x, y = y, colour = y_form)) +
                    xlab(paste0("X", i)) +
                    ylab(paste0("Y", j)) +
                    theme(legend.title = element_blank())

            }) %>% ggarrange(plotlist = ., common.legend = TRUE) %>%
                annotate_figure(bottom = paste(model[[k]]$f1 %>% class(),
                                               paste(c("sd1", "sd2"), "=", sd_tests[[k]],
                                               sep= " ", collapse = '     '),
                                               sep = ' ')
                                )
        })
    })
})
```

## qualité des modeles

```{r}
R2 <- function(y, y_pred, k = 1){
    SCEy <- sum((y - y_pred)^2, na.rm = TRUE)
    SCEt <- sum((y-mean(y))^2, na.rm = TRUE)
    R2 <- 1 - SCEy/SCEt
    n <- length(y)
    R2adj <- 1-((1-R2)*(n-1))/(n-k-1)
    list(R2=R2, R2adj=R2adj)
}


qlt <- lapply(c(sd_1 = 1, sd_30 = 3), function(s){
    lapply(list(lm = model_lm, rf = model_rf), function(model){
        lapply(list(f1 = 1, f2 = 2) , function(j){
            lapply(list(train = "train", test = "test"), function(tt){
                if (tt == "test"){
                    X <- X_big[1001:1050,]
                }else if (tt == "train"){
                    X
                }
                yy <- data.frame(pred = predict(model[[s]][[j]], X),
                           true = F1(X)
                )
                R2_y <- R2(y = yy$true, y_pred = yy$pred, k = 4)$R2adj %>% round(2)
                ggplot(yy) +
                    geom_point(aes(x = true, y = pred)) +
                    geom_abline(aes(slope = 1, intercept = 0)) +
                    geom_text(aes(x=50, y=150,
                                  label = paste("R²=", R2_y)),size = 5) +
                    xlab(paste0("y", j, '_', tt, "_true")) +
                    ylab(paste0("y", j, '_', tt, "_pred"))
            })
        })
    })
})
ggarrange(plotlist = c(qlt$sd_1$lm$f1, qlt$sd_1$lm$f2))
ggarrange(plotlist = c(qlt$sd_30$lm$f1, qlt$sd_30$lm$f2))

ggarrange(plotlist = c(qlt$sd_1$rf$f1, qlt$sd_1$rf$f2))
ggarrange(plotlist = c(qlt$sd_30$rf$f1, qlt$sd_30$rf$f2))
```

## Front de pareto
 
```{r}
# difference entre l'espace des solution reel et modelise
objective_space <- lapply(list(lm = model_lm, rf = model_rf), function(model){
    lapply(c(sd_1 = 1, sd_30 = 3), function(s){
        data.frame(id=1:160000,
                   f1_esti = predict(model[[s]][[1]], newdata = X_big),
                   f2_esti = predict(model[[s]][[2]], newdata = X_big),
                   f1_true = F1(X_big),
                   f2_true = F2(X_big)) %>%
            gather(key = key, value = value, -id) %>%
            tidyr::extract(key, into = c("f", "y_form"), regex = "([[:alnum:]]+)_([[:alnum:]]+)") %>%
            spread(f, value) %>% select(-id) %>% arrange(desc(y_form)) %>%
            ggplot() +
            geom_point(aes(x = f1, y=f2, colour=y_form)) +
            scale_color_manual(values = c("blue", "red"))

    })
})

#load sort and sel the pareto front
list_simu_bias <- lapply(list.files("../simu_server/bias_model/output/")[-1], function(file_name){
    readRDS(paste0("../simu_server/bias_model/output/", file_name))
})

sel <- 1:length(list_simu_bias) %>% sapply(function(i){
    if(list_simu_bias[[i]]$config$sd1 != 15) i else NA
})

list_simu_bias <- list_simu_bias[list_simu_bias %>% sapply(function(res){
    res$config$sd1
}) %>% order]

list_simu_bias <- list_simu_bias[list_simu_bias %>% sapply(function(res){
    ifelse(res$config$model == "lm", 1, 2)
}) %>% order]

list_simu_bias <- list_simu_bias[sel[!is.na(sel)]]

pareto <- list_simu_bias %>% lapply(function(simu){
        simu$res %>% lapply(function(S){
        S$Y
    }) %>% bind_rows() %>%
        mutate(id_simu = rep(1:32, each = 50) %>% as.factor())
    })

#plot final
lapply(1:4, function(i){
    c(objective_space$lm, objective_space$rf)[[i]] +
        geom_line(data = pareto[[i]],
                  aes(x = V1, y=V2, group = id_simu), colour = "green")
})
```

